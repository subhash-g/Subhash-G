<!--<div id="top-bar">
	<div class="logo">
		<img src="/images/boomtrain.png" />
	</div>
</div>-->
<div id="banner">
	<p id="banner_message"></p>
</div>

<div id="title-bar">
	<div class="logo">
		<img src="<%= logo %>" />
	</div>
</div>

<div id="body">
	<div id="left-menu">
		<div class="menu-items">
			<div class="menu-item">
				<img src="/images/profile-off.png" id="list-icon"/><a id="btn-my-list" href="javascript:void(0);">My Lists</a>
			</div>
			<div class="menu-item">
				<img src="/images/list-on.png" id="profile-icon"/><a id="btn-my-profile" href="javascript:void(0);">My Profile</a>
			</div>
		</div>
	</div>

	<div id="content">
		<div id="profile-form" class="form">
			<div class="fieldset-container">
				<% profile.forEach(function(prop, index) { %>
					<fieldset>
						<label><%= prop.name %></label>
						<input type="text" class="profile-input" data-property="<%= prop.property %>" value="<%= prop.value %>">
					</fieldset>
				<% }); %>
			</div>
			<div>
				<input id="btn-save-profile" class="btn btn-save" type="submit" value="Save Profile">
			</div>
		</div>
		<div id="list-form" class="form">
			<div class="fieldset-container">
                <% if ( name != 'HonestReporting') { %>  <!-- DO FOR EVERYONE EXCEPT... -->

    				<% if(header) { %>
    					<div class="header"><%= header %></div>
    				<% } %>

                <% } else { %>  <!-- DO FOR OTHERS -->

            		<!-- START: Honest Reporting Only -->
        			<% if ( name == 'HonestReporting') { %>
                        <% if(header) { %>
                            <div class="header" style="text-align:left !important"><%= header %></div>
                        <% } %>
                        <!-- START: add a div to contain NON EDITABLE user prefs -->
        				<% counter = 0 %>
        				<% profile.forEach(function(prop, index) { %>
    						<% if(counter == 0) { %>
        						<div class="header" style="text-align:left !important">
        						<p>You are subscribed as <%= prop.name %>:&nbsp;<b><%= prop.value %> </b></p>
        						</div>
    						<% } %>
    					<% counter++ %>
                        <% }); %>
    	           	<!-- END: add a div to contain user prefs -->
            		<% } %>
    		        <!-- END: Honest Reporting Only -->

                <% } %>     <!-- END IF -->


				<% if ( name == 'WNYT'){ %> <!-- SET LAYOUT FOR ONLY WNYT -->
					<% counter = 1 %>

					<fieldset class="dropdown">  <!-- WNYT SECTION 1: DROPDOWN FOR FIRST 4 USER PROPS -->
						<select id="WNYT">
							<% lists.forEach(function(list, index) { %>
							<% if(counter<= 4) { %>
								<% if(list.value ==  list.name) { %>
									<option type="dropdown" class="list-input" value="<%= list.name %>" data-property="<%= list.property %>" selected> <%= list.name %></option>
								<% } else { %>
									<option type="dropdown" class="list-input" value="<%= list.name %>" data-property="<%= list.property %>"> <%= list.name %></option>
								<% } %>
								<% counter++ %>

							<% } else if(counter==5){%>	 <!-- WNYT SECTION 2: CHECKBOXES FOR OTHER USER PROPS -->

								<input type="checkbox" id="checkboxG<%= counter %>" class="css-checkbox list-input" data-property="<%= list.property %>" data-property-value="<%= list.type == 'array' ? list.name : '' %>" data-property-type="<%= list.type %>" <%= list.value.toLowerCase() == 'false' ? '' : 'checked' %> />
								<label for="checkboxG<%= counter%>" class="css-label radGroup1" checked><%= list.name %></label><br />
								<% if(list.description) { %>
									<div class="description" style="text-align:left !important;"><%= list.description %></div>

								<% } %>
								<div>&nbsp;</div>

							<% } %>
							<% }); %>
						</select>
					</fieldset>

				<% } else if ( name == 'KOB'){ %> <!-- SET LAYOUT FOR ONLY KOB -->
					<% counter = 1 %>

					<fieldset class="dropdown">  <!-- KOB SECTION 1: DROPDOWN FOR FIRST 4 USER PROPS -->
						<select id="KOB">
							<% lists.forEach(function(list, index) { %>
							<% if(counter<= 4) { %>
								<% if(list.value ==  list.name) { %>
									<option type="dropdown" class="list-input" value="<%= list.name %>" data-property="<%= list.property %>" selected> <%= list.name %></option>
								<% } else { %>
									<option type="dropdown" class="list-input" value="<%= list.name %>" data-property="<%= list.property %>"> <%= list.name %></option>
								<% } %>
								<% counter++ %>

							<% } else if(counter==5){%>	 <!-- KOB SECTION 2: CHECKBOXES FOR OTHER USER PROPS -->

								<input type="checkbox" id="checkboxG<%= counter %>" class="css-checkbox list-input" data-property="<%= list.property %>" data-property-value="<%= list.type == 'array' ? list.name : '' %>" data-property-type="<%= list.type %>" <%= list.value.toLowerCase() == 'false' ? '' : 'checked' %> />
								<label for="checkboxG<%= counter%>" class="css-label radGroup1" checked><%= list.name %></label><br />
								<% if(list.description) { %>
									<div class="description" style="text-align:left !important;"><%= list.description %></div>

								<% } %>
								<div>&nbsp;</div>

							<% } %>
							<% }); %>
						</select>
					</fieldset>


				<% } else if ( name == 'Diginomica')  { %> <!-- SET LAYOUT FOR ONLY DIGINOMICA -->

					<fieldset class="dropdown"> <!-- ALL DIGINOMICA USER PROPS PRESENTED AS DROPDOWN -->
						<select id="Diginomica">
							<% lists.forEach(function(list, index) { %>
								<% if(list.value ==  list.name) { %>
									<option type="dropdown" class="list-input" value="<%= list.name %>" data-property="<%= list.property %>" selected> <%= list.name %></option>
								<% } else { %>
									<option type="dropdown" class="list-input" value="<%= list.name %>" data-property="<%= list.property %>"> <%= list.name %></option>
								<% } %>
							<% }); %>
						</select>
					</fieldset>

				<% } else if ( name == 'The Gazette')  { %> <!-- SET LAYOUT FOR ONLY THE GAZETTE -->
				<% counter = 1 %>
				<fieldset>
				  <% lists.forEach(function(list, index) { %>
				    <% if(index <= 5) { %>
				      <input type="checkbox" id="checkboxG<%= counter %>" class="css-checkbox list-input" data-property="<%= list.property %>" data-property-value="<%= list.type == 'array' ? list.name : '' %>" data-property-type="<%= list.type ? list.type : '' %>" <%= list.value.toLowerCase() == 'false' ? '' : 'checked' %> />
				      <label for="checkboxG<%= counter%>" class="css-label radGroup1" checked><%= list.name %></label><br />

				      <% if(list.description) { %>
				        <div class="description"><%= list.description %></div>
				      <% } %>
				      <% counter++ %>
				    <% } %>
				  <% }); %>
				</fieldset>
				<fieldset>
				  <% lists.forEach(function(list, index) { %>
				    <% if(index > 5) { %>
				      <input type="checkbox" id="checkboxG<%= counter %>" class="css-checkbox list-input" data-property="<%= list.property %>" data-property-value="<%= list.type == 'array' ? list.name : '' %>" data-property-type="<%= list.type %>" <%= list.value.toLowerCase() == 'false' ? '' : 'checked' %> />
				      <label for="checkboxG<%= counter%>" class="css-label radGroup1" checked><%= list.name %></label><br />
				      <% if(list.description) { %>
				        <div class="description"><%= list.description %></div>
				      <% } %>
				      <% counter++ %>
				    <% } %>
				  <% }); %>
				</fieldset>


				<% } else { %>
					<% counter = 1 %>
					<fieldset>
						<% lists.forEach(function(list, index) { %>
							<% if(index % 2 == 0) { %>
								<input type="checkbox" id="checkboxG<%= counter %>" class="css-checkbox list-input" data-property="<%= list.property %>" data-property-value="<%= list.type == 'array' ? list.name : '' %>" data-property-type="<%= list.type ? list.type : '' %>" <%= list.value.toLowerCase() == 'false' ? '' : 'checked' %> />
								<label for="checkboxG<%= counter%>" class="css-label radGroup1" checked><%= list.name %></label><br />

								<% if(list.description) { %>
									<div class="description"><%= list.description %></div>
								<% } %>
								<% counter++ %>
							<% } %>
						<% }); %>
					</fieldset>
					<fieldset>
						<% lists.forEach(function(list, index) { %>
							<% if(index % 2 == 1) { %>
								<input type="checkbox" id="checkboxG<%= counter %>" class="css-checkbox list-input" data-property="<%= list.property %>" data-property-value="<%= list.type == 'array' ? list.name : '' %>" data-property-type="<%= list.type %>" <%= list.value.toLowerCase() == 'false' ? '' : 'checked' %> />
								<label for="checkboxG<%= counter%>" class="css-label radGroup1" checked><%= list.name %></label><br />
								<% if(list.description) { %>
									<div class="description"><%= list.description %></div>
								<% } %>
								<% counter++ %>
							<% } %>
						<% }); %>
					</fieldset>
				<% } %>





			</div>
			<div>
				<input id="btn-save-list" class="btn btn-save" type="submit" value="Save My List">
			</div>
			<div class="unsub">
				<a id="btn-unsub-all">Unsubscribe from All</a>
			</div>
			<div class="message_uid"></div>
			<div id="powered_by"><span>Powered by</span><br />
				<div class="logo"><a href="http://boomtrain.com" target="_blank"><img src="/images/boomtrain-white.png" /></a></div>
			</div>
		</div>
	</div>
</div>

<script>
var selectMyProfile = function() {
	$("#list-form").hide();
	$("#btn-my-list").removeClass("selected");
	$("#profile-icon").attr("src","/images/profile-on.png");
	$("#list-icon").attr("src","/images/list-off.png");
	$("#profile-form").show();
	$("#btn-my-profile").addClass("selected");
}

var selectMyList = function() {
	$("#profile-form").hide();
	$("#btn-my-profile").removeClass("selected");
	$("#profile-icon").attr("src","/images/profile-off.png");
	$("#list-icon").attr("src","/images/list-on.png");
	$("#list-form").show();
	$("#btn-my-list").addClass("selected");
}

var updatePreferences = function() {
	var preferences = {};

	$(".profile-input").toArray().forEach(function(item) {
		var key = $(item).attr("data-property");
		preferences[key] = $(item).val();
	});


	var selected = false;
	$(".list-input").toArray().forEach(function(item) {
		var key = $(item).attr("data-property");
		var dataVal = $(item).attr("data-property-value");
		var dataType = $(item).attr("data-property-type");
		var type = $(item).attr("type");

		if (type != "dropdown") {
			if (dataType == 'array') {
				if (key in preferences) {
					if (item.checked) {
						preferences[key].push(dataVal);
					}
				} else {
					if (item.checked) {
						preferences[key] = [dataVal];
					} else {
						preferences[key] = [];
					}
				}
			} else {
				preferences[key] = item.checked ? "true": "false";
			}
		} else {
			//console.log(key + " item selected " + item.selected);
			if (!selected && item.selected) {
				preferences[key] = $(item).val();
				selected = true;
			}
		}
	});

	if (getParameterByName("message_uid")) {
		var url = "/preferences/<%= customerId %>/users/<%= userId %>?message_uid=" + getParameterByName("message_uid");
	} else {
		var url = "/preferences/<%= customerId %>/users/<%= userId %>";
	}

	$.ajax({
		url: url,
		method: 'POST',
		data: JSON.stringify(preferences),
		beforeSend: function(xhr, settings) {
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.setRequestHeader("Accept", "application/json");
		},
		success: function(data, status, xhr) {
			alert("Preferences successfully updated.");
		},
		error: function(xhr, status, error) {
			alert("An error occurred updating your preferences(" + error.message + ").  Please try again.");
		}
	});

	mixpanel.track("preferences-updated", {'customerId': <%= customerId %> });

	return false;
};

function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
}

var unsubscribeAll = function() {
	var url = "/preferences/<%= customerId %>/users/<%= originalUserId %>/unsubscribeAll";

	$.ajax({
		url: url,
		method: 'POST',
		data: "",
		beforeSend: function(xhr, settings) {
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.setRequestHeader("Accept", "application/json");
		},
		success: function(data, status, xhr) {
			alert("Unsubscribe all successfully updated.");
		},
		error: function(xhr, status, error) {
			alert("An error occurred updating your preferences(" + error.message + ").  Please try again.");
		}
	});

	mixpanel.track("preferences-updated", {'customerId': <%= customerId %> });

}

$("#btn-my-profile").click(selectMyProfile);
$("#btn-my-list").click(selectMyList);
$("#btn-save-profile").click(updatePreferences);
$("#btn-save-list").click(updatePreferences);

//$("#btn-unsub-all").click(unsubscribeAll);

// saves message_uid
if (getParameterByName("message_uid")) {
	$(".message_uid").attr("id", getParameterByName("message_uid"));
	$("#btn-unsub-all").attr("href", "/preferences/<%= customerId %>/users/<%= originalUserId %>/unsubscribeAll?message_uid=" + getParameterByName("message_uid"));
} else {
	$("#btn-unsub-all").attr("href", "/preferences/<%= customerId %>/users/<%= originalUserId %>/unsubscribeAll");
}

var message = '<%- req.flash('message') %>';
if (message != '') {
	alert(message);
}


var page = getParameterByName('page');
if(page && page != '') {
	if(page == "1") {
		selectMyList();
	}
	else if(page == "2") {
		selectMyProfile();
	}
	else {
		selectMyList();
	}
}
else {
	selectMyList();
}
status = ('<%= unsubStatus %>');
list = ('<%= unsubListName %>');
var listsObj = []
<% lists.forEach(function(list, index){ %>
	listsObj[<%= index %>] = {}
	listsObj[<%= index %>].name = ('<%= list.name %>');
	listsObj[<%= index %>].property = ('<%= list.property %>');
<% }); %>
var bannerSlide = function(unsubList, status){
	var name = ''
	for(var a = 0; a < listsObj.length; a++){
		if(listsObj[a].property === "properties."+unsubList){
			name = listsObj[a].name
		}
	}
	if(status === 'true'){
		$("#banner").css('background-color','#3DC054')
		$("#banner_message").text('You have been successfully unsubscribed from ' + name )
	} else {
		$("#banner").css('background-color','#FE314A')
		$("#banner_message").text('Unable to unsubscribe.')
	}
	$("#banner").slideDown().delay(3000).slideUp();
}
$("#banner").hide();
if(list != 'undefined')
	bannerSlide(list,status)

name = ('<%= name %>');


$("fieldset.dropdown").css({
	"padding-top": "30px !important",
		"text-align": "center !important"
});

$("select").css({
		"color": "#536266",
		"margin": "50px",
		"border": "1px solid rgba(33, 39, 54, .2)",
		"background": "transparent",
		"width": "200px",
		"padding": "20px",
		"font-size": "16px",
		"height": "50px",
		"font-family": "'Lato', sans-serif"
});

console.log("Testing Unsubscribe Count");

</script>

<script>
mixpanel.track("page-load", {'customerId': <%= customerId %> });
</script>

<script type="text/javascript" src="/js/jspatch.js"></script>
